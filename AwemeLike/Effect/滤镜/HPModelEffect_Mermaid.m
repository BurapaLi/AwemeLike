//
//  HPModelEffect_窗格.m
//  AwemeLike
//
//  Created by wang on 2019/11/10.
//  Copyright © 2019 Hytera. All rights reserved.
//

#import "HPModelEffect_Mermaid.h"

static CGFloat move[] = {
    0.118518519, 0.072916667,
    0.119559114, 0.070314873,
    0.122671482, 0.063107442,
    0.128003284, 0.052217769,
    0.13571597, 0.038575979,
    0.14577575, 0.023101058,
    0.157824674, 0.00667115529031,
    0.17114710000263, -0.009922094,
    0.18468368815446, -0.025982692,
    0.19708803093111, -0.040914594,
    0.20676698651337, -0.054158902,
    0.21204338213383, -0.065048052,
    0.21229349545643, -0.072433204,
    0.21111111111111, -0.075,
    0.21028743024939, -0.076212377,
    0.20779968212584, -0.079222677,
    0.20175291553545, -0.08177258,
    0.19467259129903,  -0.078865967,
    0.18773696357388, -0.076608604,
    0.1819070240526, -0.076734199,
    0.17976481719367, -0.077207308,
    0.18773581813141, -0.081601113,
    0.20946322911896, -0.086143997,
    0.22173151706244, -0.08749092,
    0.22239940866695, -0.087547664,
    0.22425222492715, -0.087777716,
    0.22702400248022, -0.088324174,
    0.23047914470308, -0.089251305,
    0.23466699502785, -0.090215434,
    0.2396692142756, -0.090382089,
    0.24483144211656, -0.089518644,
    0.24976673797017, -0.088070373,
    0.25443414392955, -0.086347832,
    0.25877449026264, -0.084536179,
    0.26272086241761, -0.082760214,
    0.26617877471684, -0.081125427,
    0.2690584468493, -0.079717952,
    0.27126323814905, -0.078615989,
    0.2726801255985, -0.077897818,
    0.27318179752695, -0.07764178,
    0.27539446710134, -0.075886411,
    0.27906045782632, -0.070472811,
    0.28309059044975, -0.062402202,
    0.28784127651796, -0.052823448,
    0.2938131661088, -0.042912984,
    0.30147519302936, -0.033965668,
    0.31079305066419, -0.027456511,
    0.31952954869245, -0.024452041,
    0.32322881788195, -0.023870652,
    0.32903287946536, -0.024644665,
    0.34208735517467, -0.027995873,
    0.35775634016309, -0.031887488,
    0.37137980569192, -0.034428283,
    0.37726142551241, -0.035120858,
    0.388233292010643, -0.035210924,
    0.3944363388028, -0.034962112,
    0.40885179397723,  -0.034417264,
    0.42090321915549,  -0.033749493,
    0.42592592592593, -0.033333333,
    0.44021577146277, -0.027822785,
    0.43968705740814, -0.009454641,
    0.43333333333333, 0.0
};

static CGFloat alpha[] = {
    0,
    0.04705882352941,
    0.09411764705882,
    0.14117647058824,
    0.18823529411765,
    0.23529411764706,
    0.28235294117647,
    0.32941176470588,
    0.37647058823529,
    0.42352941176471,
    0.47058823529412,
    0.51764705882353,
    0.56470588235294,
    0.61176470588235,
    0.65882352941176,
    0.70588235294118,
    0.75294117647059,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.8,
    0.76190476190476,
    0.72380952380952,
    0.68571428571429,
    0.64761904761905,
    0.60952380952381,
    0.57142857142857,
    0.53333333333333,
    0.4952380952381,
    0.45714285714286,
    0.41904761904762,
    0.38095238095238,
    0.34285714285714,
    0.3047619047619,
    0.26666666666667,
    0.22857142857143,
    0.19047619047619,
    0.15238095238095,
    0.11428571428571,
    0.07619047619048,
    0.03809523809524,
    0,
    0
};
    
static CGFloat shift_c[] = {
    0.01,
    0.01,
    0.01,
    0.01,
    0.01,
    0.01,
    0.01,
    0.01,
    0.01,
    0.01,
    0.01,
    0.01,
    0.01,
    0.009,
    0.008,
    0.007,
    0.006,
    0.005,
    0.004,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.003,
    0.002,
    0.002,
    0.002,
    0.001,
    0.001,
    0.001,
    0,
    0,
    0
};


@implementation HPModelEffect_Mermaid
{
    CMTime beginFrameTime;
}

- (void)handleTimerEvent:(CMTime)frameTime {
    if (CMTIME_IS_INVALID(beginFrameTime)) {
        beginFrameTime = frameTime;
    }
    CGFloat diff = CMTimeGetSeconds(CMTimeSubtract(frameTime, beginFrameTime));
    diff = fabs(diff);
    NSInteger count = sizeof(alpha) / sizeof(CGFloat);
    NSInteger frameCount = MIN(floor(diff * 16), count-1);
    HPModelEffectFeatureGeneral *feature = (HPModelEffectFeatureGeneral *)[self getFeatureByName:@"show_effect"];
    [feature setUniform:@"move" value:@[@(move[frameCount * 2 + 0]), @(move[frameCount * 2 + 1])]];
    [feature setUniform:@"alpha" value:@[@(alpha[frameCount])]];
    [feature setUniform:@"shift_r" value:@[@(shift_c[frameCount]), @(shift_c[frameCount])]];
    [feature setUniform:@"shift_b" value:@[@(-shift_c[frameCount]), @(-shift_c[frameCount])]];
        
    if (frameCount == count-1) {
        beginFrameTime = frameTime;
    }
}

- (void)clear {
    [super clear];
    beginFrameTime = kCMTimeInvalid;
}
@end
